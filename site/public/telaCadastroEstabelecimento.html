<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitority - Cadastro Estabelecimento</title>

  <link rel="stylesheet" href="./css/telaCadastroEstabelecimento.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lykmapipo/themify-icons@0.1.2/css/themify-icons.css">
  <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/pixeden-stroke-7-icon@1.2.3/pe-icon-7-stroke/dist/pe-icon-7-stroke.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.0/css/flag-icon.min.css">
  <link rel="stylesheet" href="./css/update.css">
  <link rel="icon" href="./assets/imgs/sobreNos.png">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.all.min.js"></script>
  <!-- <script src="./js/funcao.js"></script> -->
  <script src="./js/perfil-validacao.js"></script>
  <script src="./js/cepAPI.js"></script>
  <script src="./js/filtro_login.js"></script>
  <script src="./js/modalUpdate.js"></script>
</head>

<body onload="buscarDadoEstabelecimento(), navBar()">
  <main>
    <!-- Div que contem a parte de navegação (parte verde do menu)-->
    <div class="navegacao">
      <ul class="navbar-nav">
        <li class="nav-item">
          <!-- Foto De Perfil do USUARIO e o NOME do mesmo -->
          <div class="fotoDePerfil">
            <a href="#" class="nav-link">
              <!-- imagem do ICONE DA FOTO DE PERFIL-->
              <span class="icone"><i class="uil uil-user"></i> </span>
              <span class="titulo"><span id="b_usuario">usuário</span></span>
            </a>
          </div>
        <li class="nav-item" id="nav_dashboard">
          <a href="dashboard-tecnico.html" class="nav-link">
            <!-- Imagem do ICONE DO planos-->
            <span class="icone"> <i class="uil  uil-chart-line"></i> </span>
            <span class="titulo"> Dashboard </span>
          </a>
        </li>
        <li class="nav-item" id="nav_painel">
          <a href="./dashboard-gerente.html" class="nav-link">
            <!--Imagem do ICONE DE ADICIONAR -->
            <span class="icone"> <i class="uil uil-bell"></i> </span>
            <span class="titulo"> Painel</span>
          </a>
        </li>
        <li class="nav-item" id="nav_ocorrencia">
          <a href="ocorrencias.html" class="nav-link">
            <!-- Imagem do ICONE DO planos-->
            <span class="icone"> <i class="uil  uil-clipboard"></i> </span>
            <span class="titulo"> Ocorrências </span>
          </a>
        </li>
        <li class="nav-item" id="nav_estabelecimento">
          <a href="./telaCadastroEstabelecimento.html" class="nav-link">
            <!--Imagem do ICONE DE ADICIONAR -->
            <span class="icone"> <i class="uil uil-estate"></i> </span>
            <span class="titulo"> Estabelecimento</span>
          </a>
        </li>
        <li class="nav-item" id="nav_totem">
          <a href="./telaCadastroTotem.html" class="nav-link">
            <!--Imagem do ICONE DE ADICIONAR -->
            <span class="icone"> <i class="uil uil-server-connection"></i> </span>
            <span class="titulo"> Cadastrar Totem</span>
          </a>
        </li>
        <li class="nav-item" id="nav_func">
          <a href="./telaCadastroFunc.html" class="nav-link">
            <!--Imagem do ICONE DE ADICIONAR -->
            <span class="icone"> <i class="uil uil-user-plus"></i> </span>
            <span class="titulo"> Funcionario</span>
          </a>
        </li>
        <!-- </div> -->
        <li class="nav-item">
          <a href="configuracoes.html" class="nav-link">
            <!-- Imagem do ICONE DE CONFIGURAÇÕES -->
            <span class="icone"><i class="uil uil-cog"></i></span>
            <span class="titulo"> Configurações</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="" class="nav-link">
            <!-- Imagem do ICONE DE SUPORTE -->
            <span class="icone"><i class="uil uil-comment-question"></i>
            </span>
            <span class="titulo"> Suporte</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="./index.html" class="nav-link">
            <!-- Botão de Sair  -->
            <span class="icone"><i class="uil uil-signout"></i> </span>
            <span class="titulo"> Sair </span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Right Panel -->
    <div id="right-panel" class="right-panel">
      <div class="animated fadeIn">
        <div id="container-global" class="container-all">
          <!-- REGISTRO DO FUNCIONÁRIO -->
          <div class="titulo-2 funcionarios">
            <h3>Cadastre seus estabelecimento</h3>
            <p>Por favor, insira os dados do estabelecimento que você deseja cadastrar</p>
          </div>
          <hr>
          <div class="container-pai">
            <div class="container-filho">
              <!-- <div class="estilo-box">
                                <p>Username*</p>
                                <input
                                  class="input-empresa"
                                  id="inputUsuario"
                                  onblur="validarUsuario()"
                                  placeholder="Ex: Alem$o"
                                  required
                                />
                              </div>  -->
              <div class="estilo-box">
                <p>Nome Estabelecimento</p>
                <input class="input-empresa" id="inputNome" placeholder="Ex: Xpto Lanche" required
                  onblur="validarNome()" />
              </div>
              <div class="estilo-box">
                <p>CEP</p>
                <input class="input-empresa" id="inputCEP" placeholder="Ex: 08150200" required
                  onblur="pesquisacep(this.value),validarCEP();" onkeyup="cepMaskCode(event)" />
              </div>
              <div class="estilo-box">
                <p>Logradouro</p>
                <input class="input-empresa" id="inputLogradouro" placeholder="Ex: Av Paulista" type="text"
                  onblur="validarLogradouro()" required />
              </div>
              <div class="estilo-box">
                <p>Bairro</p>
                <input class="input-empresa" placeholder="Ex: Consolação" id="inputBairro" onblur="validarBairro()" />
              </div>
              <div class="estilo-box">
                <p>Cidade</p>
                <input class="input-empresa" placeholder="Ex: São Paulo" id="inputCidade" onblur="validarCidade()" />
              </div>
              <div id="estado_empresa_box" class="estilo-box">
                <p id="estado_empresa_cadastro">UF</p>
                <input class="select-estado" id="inputUF" name="estado" onclick="validarUF()">
              </div>
            </div>

            <div class="container-filho-2">
              <div class="estilo-box">
                <p>Numero</p>
                <input class="input-empresa" placeholder="Ex: 172" id="inputNumero" required onblur="validarNumero()" />
              </div>
              <div class="estilo-box">
                <p>Métrica de CPU (Em %)</p>
                <input class="input-empresa" id="inputNumeroMetricaCpu" placeholder="Ex: 80" required />
              </div>
              <div class="estilo-box">
                <p>Métrica Memória RAM (Em %)</p>
                <input class="input-empresa" id="inputNumeroMetricaRam" placeholder="Ex: 80" required />
              </div>
              <div class="estilo-box">
                <p>Prioridade</p>
                <select name="" id="comboPrioridade">
                  <option value="Normal">Normal</option>
                  <option value="Vip">Vip</option>
                </select>
              </div>
            </div>
          </div>
          <button class="botao-registro" onclick="cadastrarEstabelecimento()">
            CADASTRAR
          </button>
          <hr />
          <div id="tabela_funcionarios" class="tabela-funcionarios">
            <h3>ESTABELECIMENTOS</h3>
          </div>
        </div>
        <!-- /.content -->
      </div>
    </div>
    <!-- /#right-panel -->

    <div id="my_modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-direita">
            <h2>Editar Totem</h2>
          </div>
          <div class="logo-header">
            <img src="./assets/imgs/logoHome.png" alt="" class="img-modal">
          </div>
          <div class="modal-esquerda">
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
        </div>
        <div class="modal-body">
          <div class="modal-meio">
            <div class="lado-direito-modal">
              <div class="containerInput">
                <input class="input-margin" placeholder="Nome Estabelecimento" id="input_nome">
              </div>
              <div class="containerInput">
                <input class="input-margin" placeholder="CEP" id="input_senha">

              </div>
              <div class="containerInput">
                <input class="input-margin" placeholder="Logradouro" id="input_tel">
              </div>
              <div class="containerInput">
                <input class="input-margin" placeholder="Bairro" id="input_tel">
              </div>
              <div class="containerInput">
                <input class="input-margin" placeholder="Cidade" id="input_tel">
              </div>
            </div>

            <div class="lado-esquerdo-modal">
              <div class="containerInput">
                <input class="input-margin" placeholder="UF" id="input_tel">
              </div>
              <div class="containerInput">
                <input class="input-margin" placeholder="Número" id="input_tel">
              </div>
              <div class="containerInput">
                <input class="input-margin" placeholder="Métrica CPU" id="input_email">
              </div>
              <div class="containerInput">
                  <input class="input-margin" placeholder="Métrica Ram" id="input_email">
              </div>
              <div class="containerInput">
                <select class="input-margin" name="select" id="input_prioridade">
                  <option value="">Prioridade</option>
                  <option value="Normal">Normal</option>
                  <option value="Vip">Vip</option>
                </select>
              </div><!-- Container input-->
            </div>
          </div>
          <div class="botao">
            <button id="btnAtt">Confirmar</button>
          </div>
        </div>
        <div class="modal-footer">

        </div>
      </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-match-height@0.7.2/dist/jquery.matchHeight.min.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- Start of securithelp Zendesk Widget script -->
    <script id="ze-snippet"
      src="https://static.zdassets.com/ekr/snippet.js?key=2f1c47af-6ca3-4ce8-9188-958944ef0eb5"> </script>
    <!-- End of securithelp Zendesk Widget script -->
</body>

</html>
<script>
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  var sessionIdEmpresa = sessionStorage.ID_EMPRESA;
  var sessionFkEmpresa = sessionStorage.FK_EMPRESA;
  var idEmpresa = 0;
  function cadastrarEstabelecimento() {

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var estabelecimentoNomeVar = inputNome.value;
    var logradouroVar = inputLogradouro.value;
    var bairroVar = inputBairro.value;
    var cepVar = inputCEP.value;
    var cidadeVar = inputCidade.value;
    var estadoVar = inputUF.value;
    var numeroVar = inputNumero.value;
    var metricaNumeroCpuVar = inputNumeroMetricaCpu.value;
    var metricaNumeroRamVar = inputNumeroMetricaRam.value;
    var prioridadeVar = document.getElementById("comboPrioridade").value


    if (sessionIdEmpresa > 0) {
      idEmpresa = sessionIdEmpresa;
    } else if (sessionFkEmpresa > 0) {
      idEmpresa = sessionFkEmpresa;
    } else {
      console.log("id e fk empresa estão errado")
    }
    // Enviando o valor da nova input
    fetch("/estabelecimento/cadastrarEstabelecimento", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        fkEmpresa: idEmpresa,
        empresaNomeServer: estabelecimentoNomeVar,
        logradouroServer: logradouroVar,
        bairroServer: bairroVar,
        cepServer: cepVar,
        cidadeServer: cidadeVar,
        estadoServer: estadoVar,
        numeroServer: numeroVar,
        metricaCpuServer: metricaNumeroCpuVar,
        metricaRamServer: metricaNumeroRamVar,
        prioridadeServer: prioridadeVar,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta, idEmpresa);
        // Se sucesso, ele atualiza o id da empresa dentro da sessionStorage e atualiza a pág
        if (resposta.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Parabéns',
            text: 'Cadastro realizado com sucesso!',
          })

          setTimeout(() => buscarDadoEstabelecimento(), 1500);

        } else {
          Swal.fire({
            icon: 'error',
            title: 'Ops...',
            text: 'Houve um erro ao tentar realizar o cadastro!',
          })
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta, sessionStorage.FK_EMPRESA}`);
        // finalizarAguardar();
      });

    return false;
  }
  function updateEstabelecimento() {

    var idEstabelecimento = sessionStorage.ID_ESTABELECIMENTO;
    var idEmpresa = sessionStorage.ID_EMPRESA;
    //var campoAlteracao = VAMOS PEDIR AJUDA

    fetch("/estabelecimento/updateEstabelecimento/", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        idPerfil,
        idEmpresa
      })
    }).then(function (resposta) {
      buscarDadoEstabelecimento();
      if (resposta.status == 404) {
        Swal.fire({
          icon: 'error',
          title: 'Ops...',
          text: 'Deu 404!',
        })
      } else {
        throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
      }
    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    })
    window.location = "./telaCadastroEstabelecimento.html"
  }


  function buscarDadoEstabelecimento() {
    if (sessionIdEmpresa > 0) {
      idEmpresa = sessionIdEmpresa;
    } else if (sessionFkEmpresa > 0) {
      idEmpresa = sessionFkEmpresa;
    } else {
      console.log("id e fk empresa estão errado")
    }
    fetch(`/estabelecimento/listar/${idEmpresa}`)
      .then(function (resposta) {
        console.log('estou na BuscarEstabelecimento()', resposta);
        if (resposta.ok) {
          if (resposta.status == 204) {
            var tabelaFuncionarios = document.getElementById("tabela_funcionarios");
            var mensagem = document.createElement("span");
            mensagem.classList.add('mensagem');
            mensagem.innerHTML = "Nenhum resultado encontrado.";
            tabelaFuncionarios.appendChild(mensagem);
            throw "Nenhum resultado encontrado!!";
          }

          resposta.json().then(function (resposta) {
            console.log("Dados recebidos: ", JSON.stringify(resposta));

            var tabelaFuncionarios = document.getElementById("tabela_funcionarios");
            tabelaFuncionarios.innerHTML = "<h3>ESTABELECIMENTOS</h3>";
            for (let i = 0; i < resposta.length; i++) {
              var publicacao = resposta[i];

              // criando e manipulando elementos do HTML via JavaScript

              tabelaFuncionarios.innerHTML += `
                        
              <div class="func" id="${publicacao.idEstabelecimento}">
                      <div class="estilo-atributos">
                        <h5>Nome estabelecimento:</h5>
                        <p>${publicacao.nome}</p>
                      </div>
                      <div class="estilo-atributos">
                        <h5>Logradouro:</h5>
                        <p>${publicacao.logradouro}</p>
                      </div>
                      <div class="estilo-atributos">
                        <h5>Bairo:</h5>
                        <p>${publicacao.bairro}</p>
                      </div>
                      <div class="estilo-atributos">
                        <h5>CEP:</h5>
                        <p>${publicacao.cep}</p>
                      </div>
                      <div class="estilo-atributos">
                        <h5>Cidade:</h5>
                        <p>${publicacao.cidade}</p>
                      </div>
                      <div class="estilo-atributos">
                        <h5>UF:</h5>
                        <p>${publicacao.estado}</p>
                      </div>
                      <div class="estilo-atributos">
                        <h5>Numero:</h5>
                        <p>${publicacao.numero}</p>
                      </div>
                      <div class="estilo-atributos">
                        <h5>Prioridade do Estabelecimento:</h5>
                        <p>${publicacao.prioridade}</p>
                      </div>
                      <div class="btns-cards">
                        <button class="removerCard" onclick="removerCardEstabelecimento(${publicacao.idEstabelecimento})">Remover</button>
                        <button class="removerCard" onclick="openModal(${publicacao.idEstabelecimento})" >Editar</button>
                      </div>
                    </div>
                    `;
            }
          });
        } else {
          throw console.log('Estou na buscarDadosFuncionario()', JSON.stringify(resposta));
        }
      })
      .catch(function (resposta) {
        console.log(resposta);
      });
  }



  function removerCardEstabelecimento(idEstabelecimento){
    console.log(" apagar idEstabelecimento - ID" + idEstabelecimento);
        fetch(`/estabelecimento/excluir/${idEstabelecimento}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            if (resposta.ok) {
              buscarDadoEstabelecimento()
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    const botao = document.querySelector('#btnAtt')
    botao.addEventListener('click', function () {
    var coluna1 = 'nome'
    var coluna2 = 'prioridade'

    var dados = [
      {
        valor: `${input_nome.value}`,
        coluna: coluna1
      },
      {
        valor: `${(input_prioridade.value)}`,
        coluna: coluna2
      }]

    atualizarDados('estabelecimento', dados)
    closeModal()
    buscarDadoEstabelecimento()
  })
</script>